version: 1

project:
  name: python-smoke
  workspace: .

env:
  PYTHONPATH: src
  BENCH_PROFILE: slow

build:
  configure_cmd:
    - python
    - -c
    - "import sys; print('configure-ok', sys.version.split()[0])"
  build_cmd:
    - python
    - -m
    - compileall
    - src
    - tests

test:
  enabled: true
  cmd:
    - python
    - -m
    - unittest
    - discover
    - -s
    - tests
    - -p
    - test_*.py

storage:
  root: ./runs

policy:
  min_pass_rate: 1.0

targets:
  benchmark:
    description: Minimal Python benchmark fixture driven by run.cmd.
    run:
      cmd:
        - python
        - -m
        - python_smoke.bench
      runs: 3
      warmup_runs: 1
    parse:
      kind: regex
      rules:
        - name: status
          pattern: "STATUS:\\s*(PASS|FAIL)"
          type: enum
          enum: ["PASS", "FAIL"]
          required: true
        - name: time_ms
          pattern: "TIME_MS:\\s*([0-9.]+)"
          type: float
          units: ms
          better: lower
          required: true
        - name: ops_per_sec
          pattern: "OPS_PER_SEC:\\s*([0-9.]+)"
          type: float
          units: ops_per_sec
          better: higher
          required: true
    success:
      exit_code: 0
      pass_rule: status
